<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="cdzhang" />
  <meta name="description" content="" />
  
  
  <title>
    
      Chromium 多媒体（六） 
      
      
      |
    
     ZeronePlus&#39; Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/images3.png">
    <link rel="icon" href="/images/images3.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img no-lazy src="/images/images3.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">ZeronePlus</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Chromium 多媒体（六）</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2023-07-07 21:34:16
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="分类"></i>
                
                <span class="span--category">
                  <a href="/categories/Chromium/" title="Chromium">
                    <b>#</b> Chromium
                  </a>
                </span>
                
                <span class="span--category">
                  <a href="/categories/Chromium-%E5%A4%9A%E5%AA%92%E4%BD%93/" title="Chromium 多媒体">
                    <b>#</b> Chromium 多媒体
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="Chromium-多媒体（六）"><a href="#Chromium-多媒体（六）" class="headerlink" title="Chromium 多媒体（六）"></a>Chromium 多媒体（六）</h1><p>这篇文章继续介绍 EME 相关的内容。</p>
<p>上一篇文章介绍了 MediaKeySystemAccess 创建 MediaKeys 的过程，这篇文章介绍 MediaKeys 创建 MediaKeySession 以及 MediaKeySession 的一些方法。</p>
<h1 id="encrypted-事件"><a href="#encrypted-事件" class="headerlink" title="encrypted 事件"></a>encrypted 事件</h1><p>首先我们分析 video 组件的 encrypted 事件何时触发。</p>
<p>这部分其实之前介绍 MSE 的时候有分析过。当往 MP4StreamParser 中送数据的时候，如果 moov 中有加密的 track，会通过回调往上通知 encrypted 事件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MP4StreamParser::ParseMoov</span><span class="params">(BoxReader* reader)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">if</span> (!moov_-&gt;pssh.<span class="built_in">empty</span>())</span><br><span class="line">    <span class="built_in">OnEncryptedMediaInitData</span>(moov_-&gt;pssh);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MP4StreamParser::OnEncryptedMediaInitData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;ProtectionSystemSpecificHeader&gt;&amp; headers)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// TODO(strobe): ensure that the value of init_data (all PSSH headers</span></span><br><span class="line">  <span class="comment">// concatenated in arbitrary order) matches the EME spec.</span></span><br><span class="line">  <span class="comment">// See https://www.w3.org/Bugs/Public/show_bug.cgi?id=17673.</span></span><br><span class="line">  <span class="type">size_t</span> total_size = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; headers.<span class="built_in">size</span>(); i++)</span><br><span class="line">    total_size += headers[i].raw_box.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">init_data</span><span class="params">(total_size)</span></span>;</span><br><span class="line">  <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; headers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;init_data[pos], &amp;headers[i].raw_box[<span class="number">0</span>],</span><br><span class="line">           headers[i].raw_box.<span class="built_in">size</span>());</span><br><span class="line">    pos += headers[i].raw_box.<span class="built_in">size</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  encrypted_media_init_data_cb_.<span class="built_in">Run</span>(EmeInitDataType::CENC, init_data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>encrypted_media_init_data_cb_</code> 就是 SourceBufferState::OnEncryptedMediaInitData</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SourceBufferState::OnEncryptedMediaInitData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    EmeInitDataType type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; init_data)</span> </span>&#123;</span><br><span class="line">  encrypted_media_init_data_reported_ = <span class="literal">true</span>;</span><br><span class="line">  encrypted_media_init_data_cb_.<span class="built_in">Run</span>(type, init_data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SourceBufferState 里的 <code>encrypted_media_init_data_cb_</code> 就是 WebMediaPlayerImpl::OnEncryptedMediaInitData</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WebMediaPlayerImpl::OnEncryptedMediaInitData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    media::EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; init_data)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(init_data_type != media::EmeInitDataType::UNKNOWN);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">RecordEncryptedEvent</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recreate the watch time reporter if necessary.</span></span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> was_encrypted = is_encrypted_;</span><br><span class="line">  is_encrypted_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (!was_encrypted) &#123;</span><br><span class="line">    media_metrics_provider_-&gt;<span class="built_in">SetIsEME</span>();</span><br><span class="line">    <span class="keyword">if</span> (watch_time_reporter_)</span><br><span class="line">      <span class="built_in">CreateWatchTimeReporter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// `was_encrypted` = false means we didn&#x27;t have a CDM prior to observing</span></span><br><span class="line">    <span class="comment">// encrypted media init data. Reset the reporter until the CDM arrives. See</span></span><br><span class="line">    <span class="comment">// SetCdmInternal().</span></span><br><span class="line">    <span class="built_in">DCHECK</span>(!cdm_config_);</span><br><span class="line">    video_decode_stats_reporter_.<span class="built_in">reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  encrypted_client_-&gt;<span class="built_in">Encrypted</span>(</span><br><span class="line">      init_data_type, init_data.<span class="built_in">data</span>(),</span><br><span class="line">      base::<span class="built_in">saturated_cast</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt;(init_data.<span class="built_in">size</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>encrypted_client_</code> 就是 ModulesInitializer::CreateWebMediaPlayer 中创建的 HTMLMediaElementEncryptedMedia，不记得的可以回去看看</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HTMLMediaElementEncryptedMedia&amp; <span class="title">HTMLMediaElementEncryptedMedia::From</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HTMLMediaElement&amp; element)</span> </span>&#123;</span><br><span class="line">  HTMLMediaElementEncryptedMedia* supplement =</span><br><span class="line">      Supplement&lt;HTMLMediaElement&gt;::<span class="built_in">From</span>&lt;HTMLMediaElementEncryptedMedia&gt;(</span><br><span class="line">          element);</span><br><span class="line">  <span class="keyword">if</span> (!supplement) &#123;</span><br><span class="line">    supplement = <span class="built_in">MakeGarbageCollected</span>&lt;HTMLMediaElementEncryptedMedia&gt;(element);</span><br><span class="line">    <span class="built_in">ProvideTo</span>(element, supplement);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> *supplement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的 HTMLMediaElementEncryptedMedia::Encrypted 函数中通过 CreateEncryptedEvent 函数创建了一个 EncryptedEvent，然后将该 EncryptedEvent 进行 Schedule</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">HTMLMediaElementEncryptedMedia::Encrypted</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    media::EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">unsigned</span> init_data_length)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(EME_LOG_LEVEL) &lt;&lt; __func__;</span><br><span class="line"></span><br><span class="line">  Event* event;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetSupplementable</span>()-&gt;<span class="built_in">IsMediaDataCorsSameOrigin</span>()) &#123;</span><br><span class="line">    event = <span class="built_in">CreateEncryptedEvent</span>(init_data_type, init_data, init_data_length);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Current page is not allowed to see content from the media file,</span></span><br><span class="line">    <span class="comment">// so don&#x27;t return the initData. However, they still get an event.</span></span><br><span class="line">    event = <span class="built_in">CreateEncryptedEvent</span>(media::EmeInitDataType::UNKNOWN, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">GetSupplementable</span>()-&gt;<span class="built_in">GetExecutionContext</span>()-&gt;<span class="built_in">AddConsoleMessage</span>(</span><br><span class="line">        <span class="built_in">MakeGarbageCollected</span>&lt;ConsoleMessage&gt;(</span><br><span class="line">            mojom::ConsoleMessageSource::kJavaScript,</span><br><span class="line">            mojom::ConsoleMessageLevel::kWarning,</span><br><span class="line">            <span class="string">&quot;Media element must be CORS-same-origin with &quot;</span></span><br><span class="line">            <span class="string">&quot;the embedding page. If cross-origin, you &quot;</span></span><br><span class="line">            <span class="string">&quot;should use the `crossorigin` attribute and &quot;</span></span><br><span class="line">            <span class="string">&quot;make sure CORS headers on the media data &quot;</span></span><br><span class="line">            <span class="string">&quot;response are CORS-same-origin.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  event-&gt;<span class="built_in">SetTarget</span>(<span class="built_in">GetSupplementable</span>());</span><br><span class="line">  <span class="built_in">GetSupplementable</span>()-&gt;<span class="built_in">ScheduleEvent</span>(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="MediaKeys-createSession"><a href="#MediaKeys-createSession" class="headerlink" title="MediaKeys::createSession"></a>MediaKeys::createSession</h1><p>在 encrypted 事件中，通过 MediaKeys 去创建 Session</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MediaKeySession* <span class="title">MediaKeys::createSession</span><span class="params">(ScriptState* script_state,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="type">const</span> String&amp; session_type_string,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          ExceptionState&amp; exception_state)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEYS_LOG_LEVEL)</span><br><span class="line">      &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;) &quot;</span> &lt;&lt; session_type_string;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From http://w3c.github.io/encrypted-media/#createSession</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// When this method is invoked, the user agent must run the following steps:</span></span><br><span class="line">  <span class="comment">// 1. If this object&#x27;s persistent state allowed value is false and</span></span><br><span class="line">  <span class="comment">//    sessionType is not &quot;temporary&quot;, throw a new DOMException whose name is</span></span><br><span class="line">  <span class="comment">//    NotSupportedError.</span></span><br><span class="line">  <span class="comment">//    (Chromium ensures that only session types supported by the</span></span><br><span class="line">  <span class="comment">//    configuration are listed in supportedSessionTypes.)</span></span><br><span class="line">  <span class="comment">// 2. If the Key System implementation represented by this object&#x27;s cdm</span></span><br><span class="line">  <span class="comment">//    implementation value does not support sessionType, throw a new</span></span><br><span class="line">  <span class="comment">//    DOMException whose name is NotSupportedError.</span></span><br><span class="line">  WebEncryptedMediaSessionType session_type =</span><br><span class="line">      EncryptedMediaUtils::<span class="built_in">ConvertToSessionType</span>(session_type_string);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">SessionTypeSupported</span>(session_type)) &#123;</span><br><span class="line">    exception_state.<span class="built_in">ThrowDOMException</span>(DOMExceptionCode::kNotSupportedError,</span><br><span class="line">                                      <span class="string">&quot;Unsupported session type.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. Let session be a new MediaKeySession object, and initialize it as</span></span><br><span class="line">  <span class="comment">//    follows:</span></span><br><span class="line">  <span class="comment">//    (Initialization is performed in the constructor.)</span></span><br><span class="line">  <span class="comment">// 4. Return session.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">MakeGarbageCollected</span>&lt;MediaKeySession&gt;(script_state, <span class="keyword">this</span>, session_type,</span><br><span class="line">                                               config_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 MediaKeySession 的构造函数中调用 WebContentDecryptionModuleImpl::CreateSession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">MediaKeySession::<span class="built_in">MediaKeySession</span>(ScriptState* script_state,</span><br><span class="line">                                 MediaKeys* media_keys,</span><br><span class="line">                                 WebEncryptedMediaSessionType session_type,</span><br><span class="line">                                 <span class="type">const</span> MediaKeysConfig&amp; config)</span><br><span class="line">    : <span class="built_in">ExecutionContextLifecycleObserver</span>(ExecutionContext::<span class="built_in">From</span>(script_state)),</span><br><span class="line">      <span class="built_in">async_event_queue_</span>(</span><br><span class="line">          <span class="built_in">MakeGarbageCollected</span>&lt;EventQueue&gt;(<span class="built_in">GetExecutionContext</span>(),</span><br><span class="line">                                           TaskType::kMediaElementEvent)),</span><br><span class="line">      <span class="built_in">media_keys_</span>(media_keys),</span><br><span class="line">      <span class="built_in">session_type_</span>(session_type),</span><br><span class="line">      <span class="built_in">config_</span>(config),</span><br><span class="line">      <span class="built_in">expiration_</span>(std::numeric_limits&lt;<span class="type">double</span>&gt;::<span class="built_in">quiet_NaN</span>()),</span><br><span class="line">      <span class="built_in">key_statuses_map_</span>(<span class="built_in">MakeGarbageCollected</span>&lt;MediaKeyStatusMap&gt;()),</span><br><span class="line">      <span class="built_in">closed_promise_</span>(<span class="built_in">MakeGarbageCollected</span>&lt;ClosedPromise&gt;(</span><br><span class="line">          ExecutionContext::<span class="built_in">From</span>(script_state))),</span><br><span class="line">      <span class="built_in">action_timer_</span>(ExecutionContext::<span class="built_in">From</span>(script_state)</span><br><span class="line">                        -&gt;<span class="built_in">GetTaskRunner</span>(TaskType::kMiscPlatformAPI),</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    &amp;MediaKeySession::ActionTimerFired) &#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEY_SESSION_LOG_LEVEL) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  InstanceCounters::<span class="built_in">IncrementCounter</span>(InstanceCounters::kMediaKeySessionCounter);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the matching Chromium object. It will not be usable until</span></span><br><span class="line">  <span class="comment">// initializeNewSession() is called in response to the user calling</span></span><br><span class="line">  <span class="comment">// generateRequest().</span></span><br><span class="line">  WebContentDecryptionModule* cdm = media_keys-&gt;<span class="built_in">ContentDecryptionModule</span>();</span><br><span class="line">  session_ = cdm-&gt;<span class="built_in">CreateSession</span>(session_type);</span><br><span class="line">  session_-&gt;<span class="built_in">SetClientInterface</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From https://w3c.github.io/encrypted-media/#createSession:</span></span><br><span class="line">  <span class="comment">// MediaKeys::createSession(), step 3.</span></span><br><span class="line">  <span class="comment">// 3.1 Let the sessionId attribute be the empty string.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(session_id_.<span class="built_in">IsEmpty</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.2 Let the expiration attribute be NaN.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(std::<span class="built_in">isnan</span>(expiration_));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.3 Let the closed attribute be a new promise.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(!<span class="built_in">closed</span>(script_state).<span class="built_in">IsUndefinedOrNull</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.4 Let the keyStatuses attribute be empty.</span></span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(<span class="number">0u</span>, key_statuses_map_-&gt;<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.5 Let the session type be sessionType.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(session_type_ != WebEncryptedMediaSessionType::kUnknown);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.6 Let uninitialized be true.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(is_uninitialized_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.7 Let callable be false.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(!is_callable_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.8 Let the use distinctive identifier value be this object&#x27;s</span></span><br><span class="line">  <span class="comment">// use distinctive identifier.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Implement this (http://crbug.com/448922).</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.9 Let the cdm implementation value be this object&#x27;s cdm implementation.</span></span><br><span class="line">  <span class="comment">// 3.10 Let the cdm instance value be this object&#x27;s cdm instance.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 WebContentDecryptionModuleImpl::CreateSession 中调用 CdmSessionAdapter::CreateSession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;WebContentDecryptionModuleSession&gt;</span></span><br><span class="line"><span class="function"><span class="title">WebContentDecryptionModuleImpl::CreateSession</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WebEncryptedMediaSessionType session_type)</span> </span>&#123;</span><br><span class="line">  base::<span class="built_in">UmaHistogramEnumeration</span>(</span><br><span class="line">      adapter_-&gt;<span class="built_in">GetKeySystemUMAPrefix</span>() + kCreateSessionSessionTypeUMAName,</span><br><span class="line">      session_type);</span><br><span class="line">  <span class="keyword">return</span> adapter_-&gt;<span class="built_in">CreateSession</span>(session_type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CdmSessionAdapter::CreateSession 创建并返回 WebContentDecryptionModuleSessionImpl</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;WebContentDecryptionModuleSessionImpl&gt;</span></span><br><span class="line"><span class="function"><span class="title">CdmSessionAdapter::CreateSession</span><span class="params">(WebEncryptedMediaSessionType session_type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">make_unique</span>&lt;WebContentDecryptionModuleSessionImpl&gt;(<span class="keyword">this</span>,</span><br><span class="line">                                                                 session_type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WebContentDecryptionModuleSessionImpl::<span class="built_in">WebContentDecryptionModuleSessionImpl</span>(</span><br><span class="line">    <span class="type">const</span> scoped_refptr&lt;CdmSessionAdapter&gt;&amp; adapter,</span><br><span class="line">    WebEncryptedMediaSessionType session_type)</span><br><span class="line">    : <span class="built_in">adapter_</span>(adapter),</span><br><span class="line">      <span class="built_in">session_type_</span>(<span class="built_in">ConvertSessionType</span>(session_type)),</span><br><span class="line">      <span class="built_in">has_close_been_called_</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">is_closed_</span>(<span class="literal">false</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="MediaKeySession-generateRequest"><a href="#MediaKeySession-generateRequest" class="headerlink" title="MediaKeySession::generateRequest"></a>MediaKeySession::generateRequest</h1><p>创建完 MediaKeySession 后，会调用 MediaKeySession::generateRequest 方法，把之前 MP4StreamParser::ParseMoov 解析到的 init data 送给 CDM，并获得一个回执，然后将该回执发送给 License 服务器</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ScriptPromise <span class="title">MediaKeySession::generateRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ScriptState* script_state,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> String&amp; init_data_type_string,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> DOMArrayPiece&amp; init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    ExceptionState&amp; exception_state)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEY_SESSION_LOG_LEVEL)</span><br><span class="line">      &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;) &quot;</span> &lt;&lt; init_data_type_string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From https://w3c.github.io/encrypted-media/#generateRequest:</span></span><br><span class="line">  <span class="comment">// Generates a request based on the initData. When this method is invoked,</span></span><br><span class="line">  <span class="comment">// the user agent must run the following steps:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. If this object&#x27;s closing or closed value is true, return a promise</span></span><br><span class="line">  <span class="comment">//    rejected with an InvalidStateError.</span></span><br><span class="line">  <span class="keyword">if</span> (is_closing_ || is_closed_)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateRejectedPromiseAlreadyClosed</span>(exception_state);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. If this object&#x27;s uninitialized value is false, return a promise</span></span><br><span class="line">  <span class="comment">//    rejected with an InvalidStateError.</span></span><br><span class="line">  <span class="keyword">if</span> (!is_uninitialized_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateRejectedPromiseAlreadyInitialized</span>(exception_state);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. Let this object&#x27;s uninitialized be false.</span></span><br><span class="line">  is_uninitialized_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. If initDataType is the empty string, return a promise rejected</span></span><br><span class="line">  <span class="comment">//    with a newly created TypeError.</span></span><br><span class="line">  <span class="keyword">if</span> (init_data_type_string.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">    exception_state.<span class="built_in">ThrowTypeError</span>(<span class="string">&quot;The initDataType parameter is empty.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ScriptPromise</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5. If initData is an empty array, return a promise rejected with a</span></span><br><span class="line">  <span class="comment">//    newly created TypeError.</span></span><br><span class="line">  <span class="keyword">if</span> (!init_data.<span class="built_in">ByteLength</span>()) &#123;</span><br><span class="line">    exception_state.<span class="built_in">ThrowTypeError</span>(<span class="string">&quot;The initData parameter is empty.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ScriptPromise</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6. If the Key System implementation represented by this object&#x27;s cdm</span></span><br><span class="line">  <span class="comment">//    implementation value does not support initDataType as an</span></span><br><span class="line">  <span class="comment">//    Initialization Data Type, return a promise rejected with a new</span></span><br><span class="line">  <span class="comment">//    DOMException whose name is NotSupportedError. String comparison</span></span><br><span class="line">  <span class="comment">//    is case-sensitive.</span></span><br><span class="line">  <span class="comment">//    (blink side doesn&#x27;t know what the CDM supports, so the proper check</span></span><br><span class="line">  <span class="comment">//     will be done on the Chromium side. However, we can verify that</span></span><br><span class="line">  <span class="comment">//     |initDataType| is one of the registered values.)</span></span><br><span class="line">  media::EmeInitDataType init_data_type =</span><br><span class="line">      EncryptedMediaUtils::<span class="built_in">ConvertToInitDataType</span>(init_data_type_string);</span><br><span class="line">  <span class="keyword">if</span> (init_data_type == media::EmeInitDataType::UNKNOWN) &#123;</span><br><span class="line">    exception_state.<span class="built_in">ThrowDOMException</span>(DOMExceptionCode::kNotSupportedError,</span><br><span class="line">                                      <span class="string">&quot;The initialization data type &#x27;&quot;</span> +</span><br><span class="line">                                          init_data_type_string +</span><br><span class="line">                                          <span class="string">&quot;&#x27; is not supported.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ScriptPromise</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7. Let init data be a copy of the contents of the initData parameter.</span></span><br><span class="line">  DOMArrayBuffer* init_data_buffer =</span><br><span class="line">      DOMArrayBuffer::<span class="built_in">Create</span>(init_data.<span class="built_in">Data</span>(), init_data.<span class="built_in">ByteLength</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 8. Let session type be this object&#x27;s session type.</span></span><br><span class="line">  <span class="comment">//    (Done in constructor.)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 9. Let promise be a new promise.</span></span><br><span class="line">  NewSessionResultPromise* result =</span><br><span class="line">      <span class="built_in">MakeGarbageCollected</span>&lt;NewSessionResultPromise&gt;(script_state, config_,</span><br><span class="line">                                                    <span class="keyword">this</span>);</span><br><span class="line">  ScriptPromise promise = result-&gt;<span class="built_in">Promise</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10. Run the following steps asynchronously (done in generateRequestTask())</span></span><br><span class="line">  pending_actions_.<span class="built_in">push_back</span>(PendingAction::<span class="built_in">CreatePendingGenerateRequest</span>(</span><br><span class="line">      result, init_data_type, init_data_buffer));</span><br><span class="line">  <span class="built_in">DCHECK</span>(!action_timer_.<span class="built_in">IsActive</span>());</span><br><span class="line">  action_timer_.<span class="built_in">StartOneShot</span>(base::<span class="built_in">TimeDelta</span>(), FROM_HERE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 11. Return promise.</span></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面其实没有直接执行 generateRequest，而是创建了一个 PendingAction，实际执行在 MediaKeySession::GenerateRequestTask，该函数中调用 WebContentDecryptionModuleSessionImpl::InitializeNewSession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaKeySession::GenerateRequestTask</span><span class="params">(ContentDecryptionModuleResult* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          media::EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          DOMArrayBuffer* init_data_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> Continue step 10 of MediaKeySession::generateRequest().</span></span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEY_SESSION_LOG_LEVEL) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initializeNewSession() in Chromium will execute steps 10.1 to 10.9.</span></span><br><span class="line">  session_-&gt;<span class="built_in">InitializeNewSession</span>(</span><br><span class="line">      init_data_type, <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>*&gt;(init_data_buffer-&gt;<span class="built_in">Data</span>()),</span><br><span class="line">      init_data_buffer-&gt;<span class="built_in">ByteLength</span>(), result-&gt;<span class="built_in">Result</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining steps (10.10) executed in finishGenerateRequest(),</span></span><br><span class="line">  <span class="comment">// called when |result| is resolved.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebContentDecryptionModuleSessionImpl::InitializeNewSession 调用了 CdmSessionAdapter::InitializeNewSession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WebContentDecryptionModuleSessionImpl::InitializeNewSession</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    media::EmeInitDataType eme_init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> init_data_length,</span></span></span><br><span class="line"><span class="params"><span class="function">    WebContentDecryptionModuleResult result)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(init_data);</span><br><span class="line">  <span class="built_in">DCHECK</span>(session_id_.<span class="built_in">empty</span>());</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From https://w3c.github.io/encrypted-media/#generateRequest.</span></span><br><span class="line">  <span class="comment">// 6. If the Key System implementation represented by this object&#x27;s cdm</span></span><br><span class="line">  <span class="comment">//    implementation value does not support initDataType as an Initialization</span></span><br><span class="line">  <span class="comment">//    Data Type, return a promise rejected with a NotSupportedError.</span></span><br><span class="line">  <span class="comment">//    String comparison is case-sensitive.</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsSupportedKeySystemWithInitDataType</span>(adapter_-&gt;<span class="built_in">GetKeySystem</span>(),</span><br><span class="line">                                            eme_init_data_type)) &#123;</span><br><span class="line">    std::string message =</span><br><span class="line">        <span class="string">&quot;The initialization data type is not supported by the key system.&quot;</span>;</span><br><span class="line">    result.<span class="built_in">CompleteWithError</span>(</span><br><span class="line">        kWebContentDecryptionModuleExceptionNotSupportedError, <span class="number">0</span>,</span><br><span class="line">        WebString::<span class="built_in">FromUTF8</span>(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10.1 If the init data is not valid for initDataType, reject promise with</span></span><br><span class="line">  <span class="comment">//      a newly created TypeError.</span></span><br><span class="line">  <span class="comment">// 10.2 Let sanitized init data be a validated and sanitized version of init</span></span><br><span class="line">  <span class="comment">//      data. The user agent must thoroughly validate the Initialization Data</span></span><br><span class="line">  <span class="comment">//      before passing it to the CDM. This includes verifying that the length</span></span><br><span class="line">  <span class="comment">//      and values of fields are reasonable, verifying that values are within</span></span><br><span class="line">  <span class="comment">//      reasonable limits, and stripping irrelevant, unsupported, or unknown</span></span><br><span class="line">  <span class="comment">//      data or fields. It is recommended that user agents pre-parse,</span></span><br><span class="line">  <span class="comment">//      sanitize, and/or generate a fully sanitized version of the</span></span><br><span class="line">  <span class="comment">//      Initialization Data. If the Initialization Data format specified by</span></span><br><span class="line">  <span class="comment">//      initDataType supports multiple entries, the user agent should remove</span></span><br><span class="line">  <span class="comment">//      entries that are not needed by the CDM. The user agent must not</span></span><br><span class="line">  <span class="comment">//      re-order entries within the Initialization Data.</span></span><br><span class="line">  <span class="comment">// 10.3 If the preceding step failed, reject promise with a newly created</span></span><br><span class="line">  <span class="comment">//      TypeError.</span></span><br><span class="line">  std::vector&lt;<span class="type">uint8_t</span>&gt; sanitized_init_data;</span><br><span class="line">  std::string message;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">SanitizeInitData</span>(eme_init_data_type, init_data, init_data_length,</span><br><span class="line">                        &amp;sanitized_init_data, &amp;message)) &#123;</span><br><span class="line">    result.<span class="built_in">CompleteWithError</span>(kWebContentDecryptionModuleExceptionTypeError, <span class="number">0</span>,</span><br><span class="line">                             WebString::<span class="built_in">FromUTF8</span>(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10.4 If sanitized init data is empty, reject promise with a</span></span><br><span class="line">  <span class="comment">//      NotSupportedError.</span></span><br><span class="line">  <span class="keyword">if</span> (sanitized_init_data.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    result.<span class="built_in">CompleteWithError</span>(</span><br><span class="line">        kWebContentDecryptionModuleExceptionNotSupportedError, <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;No initialization data provided.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10.5 Let session id be the empty string.</span></span><br><span class="line">  <span class="comment">//      (Done in constructor.)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10.6 Let message be null.</span></span><br><span class="line">  <span class="comment">// 10.7 Let message type be null.</span></span><br><span class="line">  <span class="comment">//      (Done by CDM.)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10.8 Let cdm be the CDM instance represented by this object&#x27;s cdm</span></span><br><span class="line">  <span class="comment">//      instance value.</span></span><br><span class="line">  <span class="comment">// 10.9 Use the cdm to execute the following steps:</span></span><br><span class="line">  adapter_-&gt;<span class="built_in">InitializeNewSession</span>(</span><br><span class="line">      eme_init_data_type, sanitized_init_data, session_type_,</span><br><span class="line">      std::<span class="built_in">unique_ptr</span>&lt;media::NewSessionCdmPromise&gt;(</span><br><span class="line">          <span class="keyword">new</span> <span class="built_in">NewSessionCdmResultPromise</span>(</span><br><span class="line">              result, adapter_-&gt;<span class="built_in">GetKeySystemUMAPrefix</span>(),</span><br><span class="line">              kGenerateRequestUMAName,</span><br><span class="line">              base::<span class="built_in">BindOnce</span>(</span><br><span class="line">                  &amp;WebContentDecryptionModuleSessionImpl::OnSessionInitialized,</span><br><span class="line">                  weak_ptr_factory_.<span class="built_in">GetWeakPtr</span>()),</span><br><span class="line">              &#123;SessionInitStatus::NEW_SESSION&#125;)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CdmSessionAdapter-InitializeNewSession"><a href="#CdmSessionAdapter-InitializeNewSession" class="headerlink" title="CdmSessionAdapter::InitializeNewSession"></a>CdmSessionAdapter::InitializeNewSession</h2><p>CdmSessionAdapter::InitializeNewSession 调用了 MojoCdm::CreateSessionAndGenerateRequest</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CdmSessionAdapter::InitializeNewSession</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    media::EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    media::CdmSessionType session_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::unique_ptr&lt;media::NewSessionCdmPromise&gt; promise)</span> </span>&#123;</span><br><span class="line">  cdm_-&gt;<span class="built_in">CreateSessionAndGenerateRequest</span>(session_type, init_data_type, init_data,</span><br><span class="line">                                        std::<span class="built_in">move</span>(promise));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MojoCdm::CreateSessionAndGenerateRequest 则调用自己的 remote 端，也就是 MojoCdmService::CreateSessionAndGenerateRequest</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdm::CreateSessionAndGenerateRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CdmSessionType session_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::unique_ptr&lt;NewSessionCdmPromise&gt; promise)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!remote_cdm_) &#123;</span><br><span class="line">    promise-&gt;<span class="built_in">reject</span>(media::CdmPromise::Exception::INVALID_STATE_ERROR, <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&quot;CDM connection lost.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> promise_id = cdm_promise_adapter_.<span class="built_in">SavePromise</span>(std::<span class="built_in">move</span>(promise));</span><br><span class="line">  remote_cdm_-&gt;<span class="built_in">CreateSessionAndGenerateRequest</span>(</span><br><span class="line">      session_type, init_data_type, init_data,</span><br><span class="line">      base::<span class="built_in">BindOnce</span>(&amp;MojoCdm::OnNewSessionCdmPromiseResult,</span><br><span class="line">                     base::<span class="built_in">Unretained</span>(<span class="keyword">this</span>), promise_id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MojoCdmService::CreateSessionAndGenerateRequest 则调用之前 CreatePlatformCdmFactory 函数创建的 <code>cdm_</code> 的 CreateSessionAndGenerateRequest 方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdmService::CreateSessionAndGenerateRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CdmSessionType session_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    CreateSessionAndGenerateRequestCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  cdm_-&gt;<span class="built_in">CreateSessionAndGenerateRequest</span>(</span><br><span class="line">      session_type, init_data_type, init_data,</span><br><span class="line">      std::<span class="built_in">make_unique</span>&lt;NewSessionMojoCdmPromise&gt;(std::<span class="built_in">move</span>(callback)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是 Android 平台，那么之前 InterfaceFactoryImpl::GetCdmFactory 得到的就是 AndroidCdmFactory，通过 AndroidCdmFactory::Create 创建的 Cdm 就是 MediaDrmBridge，而 MediaDrmBridge 里面有 MediaDrmStorageBridge，MediaDrmStorageBridge 里面还有更深层次的成员，这里不往下追踪</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::CreateSessionAndGenerateRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CdmSessionType session_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    media::EmeInitDataType init_data_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; init_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::unique_ptr&lt;media::NewSessionCdmPromise&gt; promise)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(task_runner_-&gt;<span class="built_in">BelongsToCurrentThread</span>());</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line"></span><br><span class="line">  JNIEnv* env = <span class="built_in">AttachCurrentThread</span>();</span><br><span class="line">  ScopedJavaLocalRef&lt;jbyteArray&gt; j_init_data;</span><br><span class="line">  ScopedJavaLocalRef&lt;jobjectArray&gt; j_optional_parameters;</span><br><span class="line"></span><br><span class="line">  MediaDrmBridgeClient* client = <span class="built_in">GetMediaDrmBridgeClient</span>();</span><br><span class="line">  <span class="keyword">if</span> (client) &#123;</span><br><span class="line">    MediaDrmBridgeDelegate* delegate =</span><br><span class="line">        client-&gt;<span class="built_in">GetMediaDrmBridgeDelegate</span>(scheme_uuid_);</span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">      std::vector&lt;<span class="type">uint8_t</span>&gt; init_data_from_delegate;</span><br><span class="line">      std::vector&lt;std::string&gt; optional_parameters_from_delegate;</span><br><span class="line">      <span class="keyword">if</span> (!delegate-&gt;<span class="built_in">OnCreateSession</span>(init_data_type, init_data,</span><br><span class="line">                                     &amp;init_data_from_delegate,</span><br><span class="line">                                     &amp;optional_parameters_from_delegate)) &#123;</span><br><span class="line">        promise-&gt;<span class="built_in">reject</span>(CdmPromise::Exception::TYPE_ERROR, <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&quot;Invalid init data.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!init_data_from_delegate.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        j_init_data =</span><br><span class="line">            base::android::<span class="built_in">ToJavaByteArray</span>(env, init_data_from_delegate.<span class="built_in">data</span>(),</span><br><span class="line">                                           init_data_from_delegate.<span class="built_in">size</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!optional_parameters_from_delegate.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        j_optional_parameters = base::android::<span class="built_in">ToJavaArrayOfStrings</span>(</span><br><span class="line">            env, optional_parameters_from_delegate);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!j_init_data) &#123;</span><br><span class="line">    j_init_data =</span><br><span class="line">        base::android::<span class="built_in">ToJavaByteArray</span>(env, init_data.<span class="built_in">data</span>(), init_data.<span class="built_in">size</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ScopedJavaLocalRef&lt;jstring&gt; j_mime =</span><br><span class="line">      <span class="built_in">ConvertUTF8ToJavaString</span>(env, <span class="built_in">ConvertInitDataType</span>(init_data_type));</span><br><span class="line">  <span class="type">uint32_t</span> key_type =</span><br><span class="line">      <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(<span class="built_in">ConvertCdmSessionType</span>(session_type));</span><br><span class="line">  <span class="type">uint32_t</span> promise_id = cdm_promise_adapter_.<span class="built_in">SavePromise</span>(std::<span class="built_in">move</span>(promise));</span><br><span class="line">  <span class="built_in">Java_MediaDrmBridge_createSessionFromNative</span>(</span><br><span class="line">      env, j_media_drm_, j_init_data, j_mime, key_type, j_optional_parameters,</span><br><span class="line">      promise_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面通过 JNI 接口调用到 MediaDrm，这里不深究细节，上面方法最终调用到下面的 java 代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chromium/media/base/android/java/src/org/chromium/media/MediaDrmBridge.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a session, and generate a request with |initData| and |mime|.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param initData Data needed to generate the key request.</span></span><br><span class="line"><span class="comment"> * @param mime Mime type.</span></span><br><span class="line"><span class="comment"> * @param keyType Key type.</span></span><br><span class="line"><span class="comment"> * @param optionalParameters Additional data to pass to getKeyRequest.</span></span><br><span class="line"><span class="comment"> * @param promiseId Promise ID for this call.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">createSession</span><span class="params">(byte[] initData, String mime, <span class="type">int</span> keyType,</span></span></span><br><span class="line"><span class="params"><span class="function">        HashMap&lt;String, String&gt; optionalParameters, <span class="type">long</span> promiseId)</span> </span>&#123;</span><br><span class="line">    Log.<span class="built_in">d</span>(TAG, <span class="string">&quot;createSession()&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mMediaDrm == null) &#123;</span><br><span class="line">        Log.<span class="built_in">e</span>(TAG, <span class="string">&quot;createSession() called when MediaDrm is null.&quot;</span>);</span><br><span class="line">        <span class="built_in">onPromiseRejected</span>(promiseId, <span class="string">&quot;MediaDrm released previously.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert mMediaCryptoSession != null;</span><br><span class="line">    assert !mProvisioningPending;</span><br><span class="line"></span><br><span class="line">    boolean newSessionOpened = <span class="literal">false</span>;</span><br><span class="line">    SessionId sessionId = null;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        byte[] drmId = <span class="built_in">openSession</span>();</span><br><span class="line">        <span class="keyword">if</span> (drmId == null) &#123;</span><br><span class="line">            <span class="built_in">onPromiseRejected</span>(promiseId, <span class="string">&quot;Open session failed.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        newSessionOpened = <span class="literal">true</span>;</span><br><span class="line">        assert keyType == MediaDrm.KEY_TYPE_STREAMING || keyType == MediaDrm.KEY_TYPE_OFFLINE;</span><br><span class="line">        sessionId = (keyType == MediaDrm.KEY_TYPE_OFFLINE)</span><br><span class="line">                ? SessionId.<span class="built_in">createPersistentSessionId</span>(drmId)</span><br><span class="line">                : SessionId.<span class="built_in">createTemporarySessionId</span>(drmId);</span><br><span class="line"></span><br><span class="line">        MediaDrm.KeyRequest request =</span><br><span class="line">                <span class="built_in">getKeyRequest</span>(sessionId, initData, mime, keyType, optionalParameters);</span><br><span class="line">        <span class="keyword">if</span> (request == null) &#123;</span><br><span class="line">            <span class="built_in">closeSessionNoException</span>(sessionId);</span><br><span class="line">            <span class="built_in">onPromiseRejected</span>(promiseId, <span class="string">&quot;Generate request failed.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Success!</span></span><br><span class="line">        Log.<span class="built_in">d</span>(TAG, <span class="string">&quot;createSession(): Session (%s) created.&quot;</span>, sessionId.<span class="built_in">toHexString</span>());</span><br><span class="line">        <span class="built_in">onPromiseResolvedWithSession</span>(promiseId, sessionId);</span><br><span class="line">        <span class="built_in">onSessionMessage</span>(sessionId, request);</span><br><span class="line">        mSessionManager.<span class="built_in">put</span>(sessionId, mime, keyType);</span><br><span class="line">    &#125; <span class="built_in">catch</span> (android.media.NotProvisionedException e) &#123;</span><br><span class="line">        Log.<span class="built_in">e</span>(TAG, <span class="string">&quot;Device not provisioned&quot;</span>, e);</span><br><span class="line">        <span class="keyword">if</span> (newSessionOpened) &#123;</span><br><span class="line">            <span class="built_in">closeSessionNoException</span>(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">onPromiseRejected</span>(promiseId, <span class="string">&quot;Device not provisioned during createSession().&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">onPromiseResolvedWithSession</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> promiseId, <span class="keyword">final</span> SessionId sessionId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNativeMediaDrmBridgeValid</span>()) &#123;</span><br><span class="line">        MediaDrmBridgeJni.<span class="built_in">get</span>().<span class="built_in">onPromiseResolvedWithSession</span>(</span><br><span class="line">                mNativeMediaDrmBridge, MediaDrmBridge.<span class="keyword">this</span>, promiseId, sessionId.<span class="built_in">emeId</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="built_in">RequiresApi</span>(Build.VERSION_CODES.M)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">onSessionMessage</span><span class="params">(<span class="keyword">final</span> SessionId sessionId, <span class="keyword">final</span> MediaDrm.KeyRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isNativeMediaDrmBridgeValid</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> requestType = MediaDrm.KeyRequest.REQUEST_TYPE_INITIAL;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">        requestType = request.<span class="built_in">getRequestType</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Prior to M, getRequestType() is not supported. Do our best guess here: Assume</span></span><br><span class="line">        <span class="comment">// requests with a URL are renewals and all others are initial requests.</span></span><br><span class="line">        requestType = request.<span class="built_in">getDefaultUrl</span>().<span class="built_in">isEmpty</span>()</span><br><span class="line">                ? MediaDrm.KeyRequest.REQUEST_TYPE_INITIAL</span><br><span class="line">                : MediaDrm.KeyRequest.REQUEST_TYPE_RENEWAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MediaDrmBridgeJni.<span class="built_in">get</span>().<span class="built_in">onSessionMessage</span>(mNativeMediaDrmBridge, MediaDrmBridge.<span class="keyword">this</span>,</span><br><span class="line">            sessionId.<span class="built_in">emeId</span>(), requestType, request.<span class="built_in">getData</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意上面调用了 onPromiseResolvedWithSession 和 onSessionMessage 两个函数，前者 Resolve Promise，后者返回回执信息，这两步是分开的</p>
<h2 id="MediaDrmBridge-OnPromiseResolvedWithSession"><a href="#MediaDrmBridge-OnPromiseResolvedWithSession" class="headerlink" title="MediaDrmBridge::OnPromiseResolvedWithSession"></a>MediaDrmBridge::OnPromiseResolvedWithSession</h2><p>onPromiseResolvedWithSession 往上会调用到 MediaDrmBridge::OnPromiseResolvedWithSession，从 MediaDrmBridge::OnPromiseResolvedWithSession 开始逐步往上 Resolve Promise</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::OnPromiseResolvedWithSession</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jobject&gt;&amp; j_media_drm,</span></span></span><br><span class="line"><span class="params"><span class="function">    jint j_promise_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jbyteArray&gt;&amp; j_session_id)</span> </span>&#123;</span><br><span class="line">  std::string session_id;</span><br><span class="line">  <span class="built_in">JavaByteArrayToString</span>(env, j_session_id, &amp;session_id);</span><br><span class="line">  task_runner_-&gt;<span class="built_in">PostTask</span>(</span><br><span class="line">      FROM_HERE, base::<span class="built_in">BindOnce</span>(&amp;MediaDrmBridge::ResolvePromiseWithSession,</span><br><span class="line">                                weak_factory_.<span class="built_in">GetWeakPtr</span>(), j_promise_id,</span><br><span class="line">                                std::<span class="built_in">move</span>(session_id)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::ResolvePromiseWithSession</span><span class="params">(<span class="type">uint32_t</span> promise_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">const</span> std::string&amp; session_id)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  cdm_promise_adapter_.<span class="built_in">ResolvePromise</span>(promise_id, session_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后回到 MojoCdm::OnNewSessionCdmPromiseResult</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdm::OnNewSessionCdmPromiseResult</span><span class="params">(<span class="type">uint32_t</span> promise_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           mojom::CdmPromiseResultPtr result,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="type">const</span> std::string&amp; session_id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (result-&gt;success) &#123;</span><br><span class="line">    cdm_session_tracker_.<span class="built_in">AddSession</span>(session_id);</span><br><span class="line">    cdm_promise_adapter_.<span class="built_in">ResolvePromise</span>(promise_id, session_id);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cdm_promise_adapter_.<span class="built_in">RejectPromise</span>(promise_id, result-&gt;exception,</span><br><span class="line">                                       result-&gt;system_code,</span><br><span class="line">                                       result-&gt;error_message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 session_id 返回给上层</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NewSessionCdmResultPromise::resolve</span><span class="params">(<span class="type">const</span> std::string&amp; session_id)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;: session_id = &quot;</span> &lt;&lt; session_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// |new_session_created_cb_| uses a WeakPtr&lt;&gt; and may not do anything</span></span><br><span class="line">  <span class="comment">// if the session object has been destroyed.</span></span><br><span class="line">  SessionInitStatus status = SessionInitStatus::UNKNOWN_STATUS;</span><br><span class="line">  std::<span class="built_in">move</span>(new_session_created_cb_).<span class="built_in">Run</span>(session_id, &amp;status);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!base::<span class="built_in">Contains</span>(expected_statuses_, status)) &#123;</span><br><span class="line">    <span class="built_in">reject</span>(Exception::INVALID_STATE_ERROR, <span class="number">0</span>,</span><br><span class="line">           <span class="string">&quot;Cannot finish session initialization&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">MarkPromiseSettled</span>();</span><br><span class="line">  <span class="built_in">ReportCdmResultUMA</span>(key_system_uma_prefix_ + uma_name_, <span class="number">0</span>,</span><br><span class="line">                     <span class="built_in">ConvertStatusToUMAResult</span>(status));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only report time for promise resolution (not rejection).</span></span><br><span class="line">  base::<span class="built_in">UmaHistogramTimes</span>(key_system_uma_prefix_ + kTimeUMAPrefix + uma_name_,</span><br><span class="line">                          base::TimeTicks::<span class="built_in">Now</span>() - creation_time_);</span><br><span class="line"></span><br><span class="line">  web_cdm_result_.<span class="built_in">CompleteWithSession</span>(<span class="built_in">ConvertStatus</span>(status));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>new_session_created_cb_</code> 就是 WebContentDecryptionModuleSessionImpl::OnSessionInitialized</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WebContentDecryptionModuleSessionImpl::OnSessionInitialized</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    SessionInitStatus* status)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line">  <span class="comment">// CDM will return NULL if the session to be loaded can&#x27;t be found.</span></span><br><span class="line">  <span class="keyword">if</span> (session_id.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    *status = SessionInitStatus::SESSION_NOT_FOUND;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DCHECK</span>(session_id_.<span class="built_in">empty</span>()) &lt;&lt; <span class="string">&quot;Session ID may not be changed once set.&quot;</span>;</span><br><span class="line">  session_id_ = session_id;</span><br><span class="line">  *status =</span><br><span class="line">      adapter_-&gt;<span class="built_in">RegisterSession</span>(session_id_, weak_ptr_factory_.<span class="built_in">GetWeakPtr</span>())</span><br><span class="line">          ? SessionInitStatus::NEW_SESSION</span><br><span class="line">          : SessionInitStatus::SESSION_ALREADY_EXISTS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MediaDrmBridge-OnSessionMessage"><a href="#MediaDrmBridge-OnSessionMessage" class="headerlink" title="MediaDrmBridge::OnSessionMessage"></a>MediaDrmBridge::OnSessionMessage</h2><p>将 Cdm 的回执回传是通过另一个接口，也就是 <code>session_message_cb_</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::OnSessionMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jobject&gt;&amp; j_media_drm,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jbyteArray&gt;&amp; j_session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    jint j_message_type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jbyteArray&gt;&amp; j_message)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="type">uint8_t</span>&gt; message;</span><br><span class="line">  <span class="built_in">JavaByteArrayToByteVector</span>(env, j_message, &amp;message);</span><br><span class="line">  CdmMessageType message_type =</span><br><span class="line">      <span class="built_in">GetMessageType</span>(<span class="built_in">static_cast</span>&lt;RequestType&gt;(j_message_type));</span><br><span class="line"></span><br><span class="line">  std::string session_id;</span><br><span class="line">  <span class="built_in">JavaByteArrayToString</span>(env, j_session_id, &amp;session_id);</span><br><span class="line">  task_runner_-&gt;<span class="built_in">PostTask</span>(</span><br><span class="line">      FROM_HERE, base::<span class="built_in">BindOnce</span>(session_message_cb_, std::<span class="built_in">move</span>(session_id),</span><br><span class="line">                                message_type, message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>session_message_cb_</code> 往上会调用到 MojoCdmService::OnSessionMessage</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdmService::OnSessionMessage</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      ::media::CdmMessageType message_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; message)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  <span class="keyword">if</span> (client_) &#123;</span><br><span class="line">    client_-&gt;<span class="built_in">OnSessionMessage</span>(session_id, message_type, message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>client_</code> 是 MojoCdm 构造函数中设置的，这样 MojoCdm 和 MojoCdmService 可以互相调用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">MojoCdm::<span class="built_in">MojoCdm</span>(mojo::Remote&lt;mojom::ContentDecryptionModule&gt; remote_cdm,</span><br><span class="line">                 media::mojom::CdmContextPtr cdm_context,</span><br><span class="line">                 <span class="type">const</span> SessionMessageCB&amp; session_message_cb,</span><br><span class="line">                 <span class="type">const</span> SessionClosedCB&amp; session_closed_cb,</span><br><span class="line">                 <span class="type">const</span> SessionKeysChangeCB&amp; session_keys_change_cb,</span><br><span class="line">                 <span class="type">const</span> SessionExpirationUpdateCB&amp; session_expiration_update_cb)</span><br><span class="line">    : <span class="built_in">remote_cdm_</span>(std::<span class="built_in">move</span>(remote_cdm)),</span><br><span class="line">      <span class="built_in">cdm_id_</span>(cdm_context-&gt;cdm_id),</span><br><span class="line">      <span class="built_in">decryptor_remote_</span>(std::<span class="built_in">move</span>(cdm_context-&gt;decryptor)),</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> BUILDFLAG(IS_WIN)</span></span><br><span class="line">      <span class="built_in">requires_media_foundation_renderer_</span>(</span><br><span class="line">          cdm_context-&gt;requires_media_foundation_renderer),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// BUILDFLAG(IS_WIN)</span></span></span><br><span class="line">      <span class="built_in">session_message_cb_</span>(session_message_cb),</span><br><span class="line">      <span class="built_in">session_closed_cb_</span>(session_closed_cb),</span><br><span class="line">      <span class="built_in">session_keys_change_cb_</span>(session_keys_change_cb),</span><br><span class="line">      <span class="built_in">session_expiration_update_cb_</span>(session_expiration_update_cb) &#123;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line">  <span class="built_in">DCHECK</span>(cdm_id_);</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; cdm_id: &quot;</span></span><br><span class="line">           &lt;&lt; CdmContext::<span class="built_in">CdmIdToString</span>(base::<span class="built_in">OptionalOrNullptr</span>(cdm_id_));</span><br><span class="line">  <span class="built_in">DCHECK</span>(session_message_cb_);</span><br><span class="line">  <span class="built_in">DCHECK</span>(session_closed_cb_);</span><br><span class="line">  <span class="built_in">DCHECK</span>(session_keys_change_cb_);</span><br><span class="line">  <span class="built_in">DCHECK</span>(session_expiration_update_cb_);</span><br><span class="line"></span><br><span class="line">  remote_cdm_-&gt;<span class="built_in">SetClient</span>(client_receiver_.<span class="built_in">BindNewEndpointAndPassRemote</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Report a false event here as a baseline.</span></span><br><span class="line">  <span class="built_in">RecordConnectionError</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Otherwise, set an error handler to catch the connection error.</span></span><br><span class="line">  remote_cdm_.<span class="built_in">set_disconnect_with_reason_handler</span>(</span><br><span class="line">      base::<span class="built_in">BindOnce</span>(&amp;MojoCdm::OnConnectionError, base::<span class="built_in">Unretained</span>(<span class="keyword">this</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MojoCdmService::OnSessionMessage 会通过 mojo 调用到 MojoCdm::OnSessionMessage</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdm::OnSessionMessage</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                               MessageType message_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; message)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line"></span><br><span class="line">  session_message_cb_.<span class="built_in">Run</span>(session_id, message_type, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>session_message_cb_</code> 就是 CdmSessionAdapter::OnSessionMessage</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CdmSessionAdapter::OnSessionMessage</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         media::CdmMessageType message_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; message)</span> </span>&#123;</span><br><span class="line">  WebContentDecryptionModuleSessionImpl* session = <span class="built_in">GetSession</span>(session_id);</span><br><span class="line">  <span class="built_in">DLOG_IF</span>(WARNING, !session) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; for unknown session &quot;</span></span><br><span class="line">                             &lt;&lt; session_id;</span><br><span class="line">  <span class="keyword">if</span> (session) &#123;</span><br><span class="line">    <span class="built_in">DVLOG</span>(<span class="number">3</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;: session_id = &quot;</span> &lt;&lt; session_id;</span><br><span class="line">    session-&gt;<span class="built_in">OnSessionMessage</span>(message_type, message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前已经通过 CdmSessionAdapter::RegisterSession 将 session_id 和 <code>base::WeakPtr&lt;WebContentDecryptionModuleSessionImpl&gt;</code> 进行了关联，上面使用 <code>GetSession(session_id)</code> 获得 session_id 对应的 WebContentDecryptionModuleSessionImpl。再往上就不分析了，最终会把回执传给 javascript，然后 javascript 把回执发给 License 服务器，从 License 服务器得到回应后再调用 MediaKeySession::update</p>
<h1 id="MediaKeySession-update"><a href="#MediaKeySession-update" class="headerlink" title="MediaKeySession::update"></a>MediaKeySession::update</h1><p>最后再看 update 方法，该方法把 License 服务器的回应下传给 Cdm</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ScriptPromise <span class="title">MediaKeySession::update</span><span class="params">(ScriptState* script_state,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">const</span> DOMArrayPiece&amp; response,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      ExceptionState&amp; exception_state)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEY_SESSION_LOG_LEVEL) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From https://w3c.github.io/encrypted-media/#update:</span></span><br><span class="line">  <span class="comment">// Provides messages, including licenses, to the CDM. When this method is</span></span><br><span class="line">  <span class="comment">// invoked, the user agent must run the following steps:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. If this object&#x27;s closing or closed value is true, return a promise</span></span><br><span class="line">  <span class="comment">//    rejected with an InvalidStateError.</span></span><br><span class="line">  <span class="keyword">if</span> (is_closing_ || is_closed_)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateRejectedPromiseAlreadyClosed</span>(exception_state);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. If this object&#x27;s callable value is false, return a promise</span></span><br><span class="line">  <span class="comment">//    rejected with an InvalidStateError.</span></span><br><span class="line">  <span class="keyword">if</span> (!is_callable_)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateRejectedPromiseNotCallable</span>(exception_state);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. If response is an empty array, return a promise rejected with a</span></span><br><span class="line">  <span class="comment">//    newly created TypeError.</span></span><br><span class="line">  <span class="keyword">if</span> (!response.<span class="built_in">ByteLength</span>()) &#123;</span><br><span class="line">    exception_state.<span class="built_in">ThrowTypeError</span>(<span class="string">&quot;The response parameter is empty.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ScriptPromise</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. Let response copy be a copy of the contents of the response parameter.</span></span><br><span class="line">  DOMArrayBuffer* response_copy =</span><br><span class="line">      DOMArrayBuffer::<span class="built_in">Create</span>(response.<span class="built_in">Data</span>(), response.<span class="built_in">ByteLength</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5. Let promise be a new promise.</span></span><br><span class="line">  SimpleResultPromise* result = <span class="built_in">MakeGarbageCollected</span>&lt;SimpleResultPromise&gt;(</span><br><span class="line">      script_state, config_, <span class="keyword">this</span>, EmeApiType::kUpdate);</span><br><span class="line">  ScriptPromise promise = result-&gt;<span class="built_in">Promise</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6. Run the following steps asynchronously (done in updateTask())</span></span><br><span class="line">  pending_actions_.<span class="built_in">push_back</span>(</span><br><span class="line">      PendingAction::<span class="built_in">CreatePendingUpdate</span>(result, response_copy));</span><br><span class="line">  <span class="keyword">if</span> (!action_timer_.<span class="built_in">IsActive</span>())</span><br><span class="line">    action_timer_.<span class="built_in">StartOneShot</span>(base::<span class="built_in">TimeDelta</span>(), FROM_HERE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7. Return promise.</span></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的动作在下面执行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaKeySession::UpdateTask</span><span class="params">(ContentDecryptionModuleResult* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 DOMArrayBuffer* sanitized_response)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> Continue step 6 of MediaKeySession::update().</span></span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEY_SESSION_LOG_LEVEL) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update() in Chromium will execute steps 6.1 through 6.8.</span></span><br><span class="line">  session_-&gt;<span class="built_in">Update</span>(<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>*&gt;(sanitized_response-&gt;<span class="built_in">Data</span>()),</span><br><span class="line">                   sanitized_response-&gt;<span class="built_in">ByteLength</span>(), result-&gt;<span class="built_in">Result</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Last step (6.8.2 Resolve promise) will be done when |result| is resolved.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>session_</code> 就是 WebContentDecryptionModuleSessionImpl</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WebContentDecryptionModuleSessionImpl::Update</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">uint8_t</span>* response,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> response_length,</span></span></span><br><span class="line"><span class="params"><span class="function">    WebContentDecryptionModuleResult result)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(response);</span><br><span class="line">  <span class="built_in">DCHECK</span>(!session_id_.<span class="built_in">empty</span>());</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From https://w3c.github.io/encrypted-media/#update.</span></span><br><span class="line">  <span class="comment">// 6.1 Let sanitized response be a validated and/or sanitized version of</span></span><br><span class="line">  <span class="comment">//     response copy. The user agent should thoroughly validate the response</span></span><br><span class="line">  <span class="comment">//     before passing it to the CDM. This may include verifying values are</span></span><br><span class="line">  <span class="comment">//     within reasonable limits, stripping irrelevant data or fields,</span></span><br><span class="line">  <span class="comment">//     pre-parsing it, sanitizing it, and/or generating a fully sanitized</span></span><br><span class="line">  <span class="comment">//     version. The user agent should check that the length and values of</span></span><br><span class="line">  <span class="comment">//     fields are reasonable. Unknown fields should be rejected or removed.</span></span><br><span class="line">  <span class="comment">// 6.2 If the preceding step failed, or if sanitized response is empty,</span></span><br><span class="line">  <span class="comment">//     reject promise with a newly created TypeError.</span></span><br><span class="line">  std::vector&lt;<span class="type">uint8_t</span>&gt; sanitized_response;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">SanitizeResponse</span>(adapter_-&gt;<span class="built_in">GetKeySystem</span>(), response, response_length,</span><br><span class="line">                        &amp;sanitized_response)) &#123;</span><br><span class="line">    result.<span class="built_in">CompleteWithError</span>(kWebContentDecryptionModuleExceptionTypeError, <span class="number">0</span>,</span><br><span class="line">                             <span class="string">&quot;Invalid response.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  adapter_-&gt;<span class="built_in">UpdateSession</span>(</span><br><span class="line">      session_id_, sanitized_response,</span><br><span class="line">      std::make_unique&lt;CdmResultPromise&lt;&gt;&gt;(</span><br><span class="line">          result, adapter_-&gt;<span class="built_in">GetKeySystemUMAPrefix</span>(), kUpdateSessionUMAName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>adapter_</code> 就是 CdmSessionAdapter</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CdmSessionAdapter::UpdateSession</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; response,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::unique_ptr&lt;media::SimpleCdmPromise&gt; promise)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">3</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;: session_id = &quot;</span> &lt;&lt; session_id;</span><br><span class="line">  cdm_-&gt;<span class="built_in">UpdateSession</span>(session_id, response, std::<span class="built_in">move</span>(promise));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CdmSessionAdapter::UpdateSession 调用 MojoCdm::UpdateSession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdm::UpdateSession</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; response,</span></span></span><br><span class="line"><span class="params"><span class="function">                            std::unique_ptr&lt;SimpleCdmPromise&gt; promise)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!remote_cdm_) &#123;</span><br><span class="line">    promise-&gt;<span class="built_in">reject</span>(media::CdmPromise::Exception::INVALID_STATE_ERROR, <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&quot;CDM connection lost.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> promise_id = cdm_promise_adapter_.<span class="built_in">SavePromise</span>(std::<span class="built_in">move</span>(promise));</span><br><span class="line">  remote_cdm_-&gt;<span class="built_in">UpdateSession</span>(</span><br><span class="line">      session_id, response,</span><br><span class="line">      base::<span class="built_in">BindOnce</span>(&amp;MojoCdm::OnSimpleCdmPromiseResult, base::<span class="built_in">Unretained</span>(<span class="keyword">this</span>),</span><br><span class="line">                     promise_id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MojoCdm 调用到 MojoCdmService</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdmService::UpdateSession</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; response,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   UpdateSessionCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  cdm_-&gt;<span class="built_in">UpdateSession</span>(</span><br><span class="line">      session_id, response,</span><br><span class="line">      std::<span class="built_in">make_unique</span>&lt;SimpleMojoCdmPromise&gt;(std::<span class="built_in">move</span>(callback)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cdm_</code> 如果是 Android，就是 MediaDrmBridge</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::UpdateSession</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; response,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::unique_ptr&lt;media::SimpleCdmPromise&gt; promise)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(task_runner_-&gt;<span class="built_in">BelongsToCurrentThread</span>());</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line"></span><br><span class="line">  JNIEnv* env = <span class="built_in">AttachCurrentThread</span>();</span><br><span class="line">  ScopedJavaLocalRef&lt;jbyteArray&gt; j_response =</span><br><span class="line">      base::android::<span class="built_in">ToJavaByteArray</span>(env, response.<span class="built_in">data</span>(), response.<span class="built_in">size</span>());</span><br><span class="line">  ScopedJavaLocalRef&lt;jbyteArray&gt; j_session_id =</span><br><span class="line">      <span class="built_in">ToJavaByteArray</span>(env, session_id);</span><br><span class="line">  <span class="type">uint32_t</span> promise_id = cdm_promise_adapter_.<span class="built_in">SavePromise</span>(std::<span class="built_in">move</span>(promise));</span><br><span class="line">  <span class="built_in">Java_MediaDrmBridge_updateSession</span>(env, j_media_drm_, j_session_id, j_response,</span><br><span class="line">                                    promise_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是通过 JNI 调用到下面的 updateSession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update a session with response.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param emeSessionId Reference ID of session to be updated.</span></span><br><span class="line"><span class="comment"> * @param response Response data from the server.</span></span><br><span class="line"><span class="comment"> * @param promiseId Promise ID of this call.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="function">CalledByNative</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">updateSession</span><span class="params">(byte[] emeSessionId, byte[] response, <span class="keyword">final</span> <span class="type">long</span> promiseId)</span> </span>&#123;</span><br><span class="line">    Log.<span class="built_in">d</span>(TAG, <span class="string">&quot;updateSession()&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mMediaDrm == null) &#123;</span><br><span class="line">        <span class="built_in">onPromiseRejected</span>(promiseId, <span class="string">&quot;updateSession() called when MediaDrm is null.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SessionId sessionId = <span class="built_in">getSessionIdByEmeId</span>(emeSessionId);</span><br><span class="line">    <span class="keyword">if</span> (sessionId == null) &#123;</span><br><span class="line">        assert <span class="literal">false</span>; <span class="comment">// Should never happen.</span></span><br><span class="line">        <span class="built_in">onPromiseRejected</span>(promiseId,</span><br><span class="line">                <span class="string">&quot;Invalid session in updateSession: &quot;</span> + SessionId.<span class="built_in">toHexString</span>(emeSessionId));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SessionInfo sessionInfo = mSessionManager.<span class="built_in">get</span>(sessionId);</span><br><span class="line">        boolean isKeyRelease = sessionInfo.<span class="built_in">keyType</span>() == MediaDrm.KEY_TYPE_RELEASE;</span><br><span class="line"></span><br><span class="line">        byte[] keySetId = null;</span><br><span class="line">        <span class="keyword">if</span> (isKeyRelease) &#123;</span><br><span class="line">            Log.<span class="built_in">d</span>(TAG, <span class="string">&quot;updateSession() for key release&quot;</span>);</span><br><span class="line">            assert sessionId.<span class="built_in">keySetId</span>() != null;</span><br><span class="line">            mMediaDrm.<span class="built_in">provideKeyResponse</span>(sessionId.<span class="built_in">keySetId</span>(), response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            keySetId = mMediaDrm.<span class="built_in">provideKeyResponse</span>(sessionId.<span class="built_in">drmId</span>(), response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        KeyUpdatedCallback cb = <span class="keyword">new</span> <span class="built_in">KeyUpdatedCallback</span>(sessionId, promiseId, isKeyRelease);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isKeyRelease) &#123;</span><br><span class="line">            mSessionManager.<span class="built_in">clearPersistentSessionInfo</span>(sessionId, cb);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sessionInfo.<span class="built_in">keyType</span>() == MediaDrm.KEY_TYPE_OFFLINE &amp;&amp; keySetId != null</span><br><span class="line">                &amp;&amp; keySetId.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mSessionManager.<span class="built_in">setKeySetId</span>(sessionId, keySetId, cb);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This can be either temporary license update or server certificate update.</span></span><br><span class="line">            cb.<span class="built_in">onResult</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (android.media.NotProvisionedException e) &#123;</span><br><span class="line">        <span class="comment">// TODO(xhwang): Should we handle this?</span></span><br><span class="line">        Log.<span class="built_in">e</span>(TAG, <span class="string">&quot;failed to provide key response&quot;</span>, e);</span><br><span class="line">    &#125; <span class="built_in">catch</span> (android.media.DeniedByServerException e) &#123;</span><br><span class="line">        Log.<span class="built_in">e</span>(TAG, <span class="string">&quot;failed to provide key response&quot;</span>, e);</span><br><span class="line">    &#125; <span class="built_in">catch</span> (java.lang.IllegalStateException e) &#123;</span><br><span class="line">        Log.<span class="built_in">e</span>(TAG, <span class="string">&quot;failed to provide key response&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">onPromiseRejected</span>(promiseId, <span class="string">&quot;Update session failed.&quot;</span>);</span><br><span class="line">    <span class="built_in">release</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面函数在 <code>cb.onResult(true);</code> 中调用回调</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">KeyUpdatedCallback</span> implements Callback&lt;Boolean&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SessionId mSessionId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> mPromiseId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> boolean mIsKeyRelease;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">KeyUpdatedCallback</span>(SessionId sessionId, <span class="type">long</span> promiseId, boolean isKeyRelease) &#123;</span><br><span class="line">        mSessionId = sessionId;</span><br><span class="line">        mPromiseId = promiseId;</span><br><span class="line">        mIsKeyRelease = isKeyRelease;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="function">Override</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="type">void</span> <span class="title">onResult</span><span class="params">(Boolean success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="built_in">onPromiseRejected</span>(mPromiseId, <span class="string">&quot;failed to update key after response accepted&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.<span class="built_in">d</span>(TAG, <span class="string">&quot;Key successfully %s for session %s&quot;</span>, mIsKeyRelease ? <span class="string">&quot;released&quot;</span> : <span class="string">&quot;added&quot;</span>,</span><br><span class="line">                mSessionId.<span class="built_in">toHexString</span>());</span><br><span class="line">        <span class="built_in">onPromiseResolved</span>(mPromiseId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mIsKeyRelease &amp;&amp; Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            <span class="built_in">onSessionKeysChange</span>(mSessionId,</span><br><span class="line">                    <span class="built_in">getDummyKeysInfo</span>(MediaDrm.KeyStatus.STATUS_USABLE).<span class="built_in">toArray</span>(), <span class="literal">true</span>,</span><br><span class="line">                    mIsKeyRelease);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是分成两个，一个是 OnPromiseResolved，一个是 OnSessionKeysChange</p>
<h2 id="MediaDrmBridge-OnPromiseResolved"><a href="#MediaDrmBridge-OnPromiseResolved" class="headerlink" title="MediaDrmBridge::OnPromiseResolved"></a>MediaDrmBridge::OnPromiseResolved</h2><p>这个函数会一直向上调用，逐步 Resolve Promise</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::OnPromiseResolved</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">const</span> JavaParamRef&lt;jobject&gt;&amp; j_media_drm,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       jint j_promise_id)</span> </span>&#123;</span><br><span class="line">  task_runner_-&gt;<span class="built_in">PostTask</span>(</span><br><span class="line">      FROM_HERE, base::<span class="built_in">BindOnce</span>(&amp;MediaDrmBridge::ResolvePromise,</span><br><span class="line">                                weak_factory_.<span class="built_in">GetWeakPtr</span>(), j_promise_id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MediaDrmBridge-OnSessionKeysChange"><a href="#MediaDrmBridge-OnSessionKeysChange" class="headerlink" title="MediaDrmBridge::OnSessionKeysChange"></a>MediaDrmBridge::OnSessionKeysChange</h2><p>OnSessionKeysChange 则是更新 key 的状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaDrmBridge::OnSessionKeysChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jobject&gt;&amp; j_media_drm,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jbyteArray&gt;&amp; j_session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> JavaParamRef&lt;jobjectArray&gt;&amp; j_keys_info,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> has_additional_usable_key,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> is_key_release)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line"></span><br><span class="line">  CdmKeysInfo cdm_keys_info;</span><br><span class="line"></span><br><span class="line">  <span class="function">JavaObjectArrayReader&lt;jobject&gt; <span class="title">j_keys_info_array</span><span class="params">(j_keys_info)</span></span>;</span><br><span class="line">  <span class="built_in">DCHECK_GT</span>(j_keys_info_array.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> j_key_status : j_keys_info_array) &#123;</span><br><span class="line">    ScopedJavaLocalRef&lt;jbyteArray&gt; j_key_id =</span><br><span class="line">        <span class="built_in">Java_KeyStatus_getKeyId</span>(env, j_key_status);</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; key_id;</span><br><span class="line">    <span class="built_in">JavaByteArrayToByteVector</span>(env, j_key_id, &amp;key_id);</span><br><span class="line">    <span class="built_in">DCHECK</span>(!key_id.<span class="built_in">empty</span>());</span><br><span class="line"></span><br><span class="line">    jint j_status_code = <span class="built_in">Java_KeyStatus_getStatusCode</span>(env, j_key_status);</span><br><span class="line">    CdmKeyInformation::KeyStatus key_status =</span><br><span class="line">        <span class="built_in">ConvertKeyStatus</span>(<span class="built_in">static_cast</span>&lt;KeyStatus&gt;(j_status_code), is_key_release);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;Key status change: &quot;</span></span><br><span class="line">             &lt;&lt; base::<span class="built_in">HexEncode</span>(&amp;key_id[<span class="number">0</span>], key_id.<span class="built_in">size</span>()) &lt;&lt; <span class="string">&quot;, &quot;</span></span><br><span class="line">             &lt;&lt; key_status;</span><br><span class="line"></span><br><span class="line">    cdm_keys_info.<span class="built_in">push_back</span>(</span><br><span class="line">        std::<span class="built_in">make_unique</span>&lt;CdmKeyInformation&gt;(key_id, key_status, <span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string session_id;</span><br><span class="line">  <span class="built_in">JavaByteArrayToString</span>(env, j_session_id, &amp;session_id);</span><br><span class="line">  task_runner_-&gt;<span class="built_in">PostTask</span>(</span><br><span class="line">      FROM_HERE,</span><br><span class="line">      base::<span class="built_in">BindOnce</span>(session_keys_change_cb_, std::<span class="built_in">move</span>(session_id),</span><br><span class="line">                     has_additional_usable_key, std::<span class="built_in">move</span>(cdm_keys_info)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (has_additional_usable_key) &#123;</span><br><span class="line">    task_runner_-&gt;<span class="built_in">PostTask</span>(</span><br><span class="line">        FROM_HERE, base::<span class="built_in">BindOnce</span>(&amp;MediaDrmBridge::OnHasAdditionalUsableKey,</span><br><span class="line">                                  weak_factory_.<span class="built_in">GetWeakPtr</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>session_keys_change_cb_</code> 就是 MojoCdmService::OnSessionKeysChange</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdmService::OnSessionKeysChange</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="type">bool</span> has_additional_usable_key,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         CdmKeysInfo keys_info)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__</span><br><span class="line">           &lt;&lt; <span class="string">&quot; has_additional_usable_key = &quot;</span> &lt;&lt; has_additional_usable_key;</span><br><span class="line">  <span class="keyword">if</span> (client_) &#123;</span><br><span class="line">    client_-&gt;<span class="built_in">OnSessionKeysChange</span>(session_id, has_additional_usable_key,</span><br><span class="line">                                 std::<span class="built_in">move</span>(keys_info));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MojoCdmService 调用 MojoCdm</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MojoCdm::OnSessionKeysChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> has_additional_usable_key,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::vector&lt;std::unique_ptr&lt;CdmKeyInformation&gt;&gt; keys_info)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (has_additional_usable_key)</span><br><span class="line">    event_callbacks_.<span class="built_in">Notify</span>(Event::kHasAdditionalUsableKey);</span><br><span class="line"></span><br><span class="line">  session_keys_change_cb_.<span class="built_in">Run</span>(session_id, has_additional_usable_key,</span><br><span class="line">                              std::<span class="built_in">move</span>(keys_info));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>session_keys_change_cb_</code> 是 CdmSessionAdapter::OnSessionKeysChange</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CdmSessionAdapter::OnSessionKeysChange</span><span class="params">(<span class="type">const</span> std::string&amp; session_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">bool</span> has_additional_usable_key,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            media::CdmKeysInfo keys_info)</span> </span>&#123;</span><br><span class="line">  WebContentDecryptionModuleSessionImpl* session = <span class="built_in">GetSession</span>(session_id);</span><br><span class="line">  <span class="built_in">DLOG_IF</span>(WARNING, !session) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; for unknown session &quot;</span></span><br><span class="line">                             &lt;&lt; session_id;</span><br><span class="line">  <span class="keyword">if</span> (session) &#123;</span><br><span class="line">    <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;: session_id = &quot;</span> &lt;&lt; session_id;</span><br><span class="line">    <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; <span class="string">&quot;  - has_additional_usable_key = &quot;</span> &lt;&lt; has_additional_usable_key;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; info : keys_info)</span><br><span class="line">      <span class="built_in">DVLOG</span>(<span class="number">2</span>) &lt;&lt; <span class="string">&quot;  - &quot;</span> &lt;&lt; *(info.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">    session-&gt;<span class="built_in">OnSessionKeysChange</span>(has_additional_usable_key,</span><br><span class="line">                                 std::<span class="built_in">move</span>(keys_info));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着调用 WebContentDecryptionModuleSessionImpl::OnSessionKeysChange</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WebContentDecryptionModuleSessionImpl::OnSessionKeysChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> has_additional_usable_key,</span></span></span><br><span class="line"><span class="params"><span class="function">    media::CdmKeysInfo keys_info)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_CALLED_ON_VALID_THREAD</span>(thread_checker_);</span><br><span class="line">  <span class="function">WebVector&lt;WebEncryptedMediaKeyInformation&gt; <span class="title">keys</span><span class="params">(keys_info.size())</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; keys_info.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; key_info = keys_info[i];</span><br><span class="line">    keys[i].<span class="built_in">SetId</span>(<span class="built_in">WebData</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;key_info-&gt;key_id[<span class="number">0</span>]),</span><br><span class="line">                          key_info-&gt;key_id.<span class="built_in">size</span>()));</span><br><span class="line">    keys[i].<span class="built_in">SetStatus</span>(<span class="built_in">ConvertCdmKeyStatus</span>(key_info-&gt;status));</span><br><span class="line">    keys[i].<span class="built_in">SetSystemCode</span>(key_info-&gt;system_code);</span><br><span class="line"></span><br><span class="line">    base::<span class="built_in">UmaHistogramSparse</span>(</span><br><span class="line">        adapter_-&gt;<span class="built_in">GetKeySystemUMAPrefix</span>() + kKeyStatusSystemCodeUMAName,</span><br><span class="line">        key_info-&gt;system_code);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now send the event to blink.</span></span><br><span class="line">  client_-&gt;<span class="built_in">OnSessionKeysChange</span>(keys, has_additional_usable_key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 <code>client_</code> 就是 MediaKeySession</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaKeySession::OnSessionKeysChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> WebVector&lt;WebEncryptedMediaKeyInformation&gt;&amp; keys,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> has_additional_usable_key)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DVLOG</span>(MEDIA_KEY_SESSION_LOG_LEVEL)</span><br><span class="line">      &lt;&lt; __func__ &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot;) with &quot;</span> &lt;&lt; keys.<span class="built_in">size</span>()</span><br><span class="line">      &lt;&lt; <span class="string">&quot; keys and hasAdditionalUsableKey is &quot;</span></span><br><span class="line">      &lt;&lt; (has_additional_usable_key ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From https://w3c.github.io/encrypted-media/#update-key-statuses:</span></span><br><span class="line">  <span class="comment">// The following steps are run:</span></span><br><span class="line">  <span class="comment">// 1. Let the session be the associated MediaKeySession object.</span></span><br><span class="line">  <span class="comment">// 2. Let the input statuses be the sequence of pairs key ID and</span></span><br><span class="line">  <span class="comment">//    associated MediaKeyStatus pairs.</span></span><br><span class="line">  <span class="comment">// 3. Let the statuses be session&#x27;s keyStatuses attribute.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. Run the following steps to replace the contents of statuses:</span></span><br><span class="line">  <span class="comment">// 4.1 Empty statuses.</span></span><br><span class="line">  key_statuses_map_-&gt;<span class="built_in">Clear</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4.2 For each pair in input statuses.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; keys.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">    <span class="comment">// 4.2.1 Let pair be the pair.</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; key = keys[i];</span><br><span class="line">    <span class="comment">// 4.2.2 Insert an entry for pair&#x27;s key ID into statuses with the</span></span><br><span class="line">    <span class="comment">//       value of pair&#x27;s MediaKeyStatus value.</span></span><br><span class="line">    key_statuses_map_-&gt;<span class="built_in">AddEntry</span>(</span><br><span class="line">        key.<span class="built_in">Id</span>(), EncryptedMediaUtils::<span class="built_in">ConvertKeyStatusToString</span>(key.<span class="built_in">Status</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5. Queue a task to fire a simple event named keystatuseschange</span></span><br><span class="line">  <span class="comment">//    at the session.</span></span><br><span class="line">  Event* event = Event::<span class="built_in">Create</span>(event_type_names::kKeystatuseschange);</span><br><span class="line">  event-&gt;<span class="built_in">SetTarget</span>(<span class="keyword">this</span>);</span><br><span class="line">  async_event_queue_-&gt;<span class="built_in">EnqueueEvent</span>(FROM_HERE, *event);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6. Queue a task to run the attempt to resume playback if necessary</span></span><br><span class="line">  <span class="comment">//    algorithm on each of the media element(s) whose mediaKeys attribute</span></span><br><span class="line">  <span class="comment">//    is the MediaKeys object that created the session. The user agent</span></span><br><span class="line">  <span class="comment">//    may choose to skip this step if it knows resuming will fail.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Attempt to resume playback if |hasAdditionalUsableKey| is true.</span></span><br><span class="line">  <span class="comment">// http://crbug.com/413413</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里就把 EME 的基本流程介绍完了。笔者之前做的项目就是把厂商提供的 CDM 库对接到 Chromium，基本上也是仿照 MediaDrmBridge 写的。</p>
<p>上面的流程中还没有看到具体的视频&#x2F;音频数据是如何解密的，这部分放在后面 WebMediaPlayer 中再介绍。</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/06/30/Chromium-%E5%A4%9A%E5%AA%92%E4%BD%93%EF%BC%88%E4%BA%94%EF%BC%89/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2023-07-07 21:34:16
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="分类"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Chromium/" title="Chromium">
                        <b>#</b> Chromium
                      </a>
                    </span>
                    
                    <span class="span--category">
                      <a href="/categories/Chromium-%E5%A4%9A%E5%AA%92%E4%BD%93/" title="Chromium 多媒体">
                        <b>#</b> Chromium 多媒体
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2023/07/07/Chromium-%E5%A4%9A%E5%AA%92%E4%BD%93%EF%BC%88%E4%B8%83%EF%BC%89/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Chromium-%E5%A4%9A%E5%AA%92%E4%BD%93%EF%BC%88%E5%85%AD%EF%BC%89"><span class="toc-text">Chromium 多媒体（六）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#encrypted-%E4%BA%8B%E4%BB%B6"><span class="toc-text">encrypted 事件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MediaKeys-createSession"><span class="toc-text">MediaKeys::createSession</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MediaKeySession-generateRequest"><span class="toc-text">MediaKeySession::generateRequest</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CdmSessionAdapter-InitializeNewSession"><span class="toc-text">CdmSessionAdapter::InitializeNewSession</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MediaDrmBridge-OnPromiseResolvedWithSession"><span class="toc-text">MediaDrmBridge::OnPromiseResolvedWithSession</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MediaDrmBridge-OnSessionMessage"><span class="toc-text">MediaDrmBridge::OnSessionMessage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MediaKeySession-update"><span class="toc-text">MediaKeySession::update</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MediaDrmBridge-OnPromiseResolved"><span class="toc-text">MediaDrmBridge::OnPromiseResolved</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MediaDrmBridge-OnSessionKeysChange"><span class="toc-text">MediaDrmBridge::OnSessionKeysChange</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'fg49dbpe7aWEpf8yQgZnaNlc-gzGzoHsz',
        appKey: 'zT8ZAY6u1L6753gMkaDp8hgW',
        placeholder: '说点什么吧',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" href="https://github.com/Zeroneplus">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://zeroneplus.github.io/">Copyright © 2023 ZeronePlus</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        

      </div>
    </div>
  
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>
</html>
